# Cursor Admin API — дашборд

Сайт забирает данные по [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api): участники команды, аудит-логи, ежедневное использование, траты, события использования, биллинг-группы, блоклисты репозиториев.

## Требования

- API key команды Cursor. Создать: [cursor.com/settings](https://cursor.com/settings).  
  Можно один раз ввести ключ на сайте и нажать **«Сохранить ключ в БД»** — он сохранится в общей БД (таблица `settings`), и вводить его снова не нужно. При запуске выгрузки проверяется наличие ключа; если ключ недействителен (401 от Cursor API), будет предложено ввести новый.

## Запуск в Docker (рекомендуется)

```bash
cd cursor-api-dashboard
docker compose up --build
```

Или без docker-compose:

```bash
docker build -t cursor-api-dashboard .
docker run -p 3333:3333 cursor-api-dashboard
```

Откройте в браузере: **http://localhost:3333**

## Запуск без Docker

- Node.js 18+

```bash
cd cursor-api-dashboard
npm install
npm start
```

Откройте в браузере: **http://localhost:3333**

## Использование

1. Вставьте **API key** (из настроек команды Cursor).
2. Укажите период **startDate** и **endDate** (для эндпоинтов с датами; макс. 30 дней по лимитам API).
3. Отметьте нужные эндпоинты или нажмите «Выбрать все».
4. Нажмите **«Загрузить выбранные эндпоинты»**.

Результаты выводятся по каждому эндпоинту в свёрнутых блоках (JSON). Для audit-logs и usage events данные подгружаются постранично.

**Дополнительно:** во время загрузки отображается прогресс «N из M» и кнопка **«Остановить»**; ошибки показываются в блоке «Последние ошибки»; у каждого результата есть **«Скачать JSON»**, а **«Скачать всё (JSON)»** сохраняет один файл со всеми выбранными эндпоинтами.

### Сохранение в локальную БД

В разделе **«Настройки и загрузка»** можно одной кнопкой загрузить данные по эндпоинтам Admin API (Team Members, Audit Logs, Daily Usage Data, Spending Data, Usage Events) с указанной даты по вчера и сохранить в SQLite (файл `data/analytics.db`). Уже загруженные дни не запрашиваются повторно. Покрытие БД отображается в том же разделе.

- **API для чтения:** `GET /api/analytics?endpoint=...&startDate=...&endDate=...` — выборка из БД.
- **Покрытие:** `GET /api/analytics/coverage` — список эндпоинтов и диапазонов дат.

### Дашборд по пользователям

**Главная страница** (`index.html`) — дашборд: пользователи из Jira (или только из Cursor по email), активность по **месяцам**: запросы, дни активности, строки кода, применения/принятия, события и стоимость из Usage Events, разбивка по моделям. Отображаются статус (активный/архивный), проект, даты подключения/отключения. Режимы: карточки, тепловая карта, таблица. Источники: **Daily Usage Data** и **Usage Events** в БД, при необходимости — загруженный CSV **Пользователи Jira**.

- **API:** `GET /api/users/activity-by-month?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD` — пользователи и агрегированная активность по месяцам.

В Docker каталог с БД и `api-key.txt` хранится **вне контейнера**: по умолчанию используется том `cursor-data`, смонтированный в `/data`. При пересоздании контейнера данные сохраняются. При необходимости можно задать свой каталог на хосте:

```bash
docker run -p 3333:3333 -e DATA_DIR=/data -v /путь/на/хосте/data:/data cursor-api-dashboard
```

## Переменные окружения (опционально)

| Переменная | Описание |
|------------|----------|
| `DATA_DIR` | Каталог для БД (по умолчанию `./data`; в Docker по умолчанию `/data` с томом). |
| `CURSOR_API_KEY` | API key команды (если не вводить на сайте). |
| `CORS_ORIGIN` | Разрешённые origins через запятую (например `http://localhost:3333`). По умолчанию — все. |
| `PROXY_TIMEOUT_MS` | Таймаут запроса к Cursor API в мс (по умолчанию 60000). |
| `RATE_LIMIT_MAX` | Макс. запросов с одного IP в минуту на наш сервер (по умолчанию 120). Лимиты самого Cursor API см. выше. |

## Лимиты Cursor Admin API

| API / эндпоинт | Лимит |
|----------------|--------|
| Admin API — большинство эндпоинтов | 20 запросов/мин |
| Admin API — `/teams/user-spend-limit` | 60 запросов/мин |

Дашборд при прокси и синхронизации автоматически соблюдает эти лимиты: запросы к одному и тому же типу эндпоинта троттлятся, чтобы не превышать лимит.

## Эндпоинты Admin API

**Чтение (GET/POST):** Team Members, Audit Logs, Daily Usage Data, Spending Data, Usage Events. Документация: https://cursor.com/docs/account/teams/admin-api

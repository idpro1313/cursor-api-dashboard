# Cursor API Dashboard

Дашборд и настройки для работы с [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api): загрузка аналитики в локальную БД, просмотр статистики по пользователям и использованию Cursor командой.

## Возможности

- **Главная страница (дашборд)** — без входа: активность по пользователям и месяцам (запросы, строки кода, события и стоимость Usage Events, токены, расходы текущего месяца (Spend API)), сводка по моделям, блок «Активные в Jira, но не используют Cursor», затраты по проекту помесячно. Источники: Daily Usage Data, Usage Events, Jira (CSV), Team Members, Spending Data.
- **Настройки (по логину и паролю):**
  - **Настройки и загрузка** — API key, одна кнопка загрузки данных из Cursor API в SQLite с указанной даты по вчера, покрытие БД, очистка (только API / только Jira / полная).
  - **Данные в БД** — просмотр сохранённых данных по эндпоинтам и датам.
  - **Пользователи Jira** — загрузка CSV из Jira, очистка данных Jira.
  - **Аудит** — события Audit Logs с фильтрами.

Логин и пароль хранятся в файле **`data/auth.json`**. При первом запуске создаётся файл с учётными данными по умолчанию: **admin** / **admin** (рекомендуется сменить).

## Требования

- Node.js 18+ (рекомендуется 20)
- API key команды Cursor: [cursor.com/settings](https://cursor.com/settings). Ключ вводится в разделе «Настройки и загрузка» и сохраняется в БД.

## Запуск

### Локально

```bash
npm install
npm start
```

Откройте в браузере: **http://localhost:3333**

- Главная — дашборд (доступ без входа).
- Ссылка **«Настройки»** → страница входа → после входа доступны разделы загрузки, данных в БД, Jira, Аудит.

### Docker

```bash
docker compose up --build
```

Данные (БД, `auth.json`, сессия, логи) хранятся в каталоге хоста **/var/cursor/data** (монтируется в контейнер). При первом запуске на Linux создайте каталог: `sudo mkdir -p /var/cursor/data`. На Windows можно использовать именованный том Docker — в `docker-compose.yml` закомментирован вариант `cursor_data:/data`.

## Переменные окружения

| Переменная | Описание |
|------------|----------|
| `PORT` | Порт HTTP (по умолчанию 3333). |
| `DATA_DIR` | Каталог для БД и файлов (по умолчанию `./data`; в Docker — `/data`). |
| `CURSOR_API_KEY` | API key команды (если не вводить в интерфейсе). |
| `CORS_ORIGIN` | Разрешённые origins через запятую. |
| `SESSION_SECRET` | Секрет для подписи сессии (опционально). |
| `USE_PYPDF` | Если `1` или `true`, для извлечения текста из PDF-счетов вызывается скрипт на [pypdf](https://github.com/py-pdf/pypdf) (требуется Python и `pypdf`). |
| `PYPDF_SCRIPT` | Путь к скрипту `scripts/parse_invoice_pypdf.py` (по умолчанию `./scripts/parse_invoice_pypdf.py`). |
| `PYPDF_PYTHON` | Исполняемый файл Python (по умолчанию `python3`). |

### Опционально: извлечение текста из PDF через pypdf

Для извлечения текста из PDF-счетов можно использовать [pypdf](https://github.com/py-pdf/pypdf). Установите Python и зависимость:

```bash
pip install pypdf
```

Задайте переменные и запустите приложение:

```bash
export USE_PYPDF=1
export PYPDF_SCRIPT=/path/to/cursor-api-dashboard/scripts/parse_invoice_pypdf.py
npm start
```

Текст из PDF извлекается через pypdf, разбор таблицы строк выполняется тем же встроенным парсером. Если скрипт завершится с ошибкой или вернёт пустой текст, используются встроенные парсеры (по структуре PDF и по тексту через pdf-parse). В Docker-образе Python и pypdf не устанавливаются — для использования задайте переменные при локальном запуске Node.

## Структура данных

- **data/analytics.db** — SQLite: таблицы `analytics` (данные по эндпоинтам и датам), `jira_users` (CSV Jira), `settings` (API key).
- **data/auth.json** — логин и пароль для входа в настройки (`{"login": "admin", "password": "admin"}`).
- **data/session_secret** — секрет сессии (создаётся автоматически).
- **data/sync.log** — лог синхронизации API (при загрузке данных в БД).

Подробнее: [DOCUMENTATION.md](DOCUMENTATION.md).

## Лимиты Cursor Admin API

- Большинство эндпоинтов: 20 запросов/мин.
- Сервер при загрузке соблюдает лимиты и не запрашивает уже загруженные дни повторно.

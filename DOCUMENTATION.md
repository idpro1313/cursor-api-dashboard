# Документация: Cursor API Dashboard

Веб-приложение для работы с [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api): прокси запросов, сохранение аналитики в локальную БД, дашборды по использованию Cursor командой и загрузка PDF-счетов Cursor с парсингом через OpenDataLoader.

---

## 1. Назначение и возможности

- **Прокси к Cursor Admin API** — запросы к API выполняются с сервера, API key не передаётся в браузер.
- **Синхронизация в БД** — загрузка данных по эндпоинтам (audit-logs, daily-usage-data, filtered-usage-events) с указанной даты по вчера с сохранением в SQLite. Уже загруженные дни не запрашиваются повторно; текущий день не загружается.
- **Просмотр данных в БД** — фильтрация по эндпоинту и диапазону дат, просмотр покрытия.
- **Пользователи Jira** — загрузка CSV (экспорт из Jira) для сопоставления с активностью Cursor по email.
- **Дашборд по пользователям** — статистика использования Cursor по месяцам: запросы, дни активности, строки кода, применения/принятия; виды: карточки, тепловая карта, таблица.
- **Счета Cursor (PDF)** — загрузка PDF-счетов, парсинг таблицы позиций через [OpenDataLoader PDF](https://github.com/opendataloader-project/opendataloader-pdf) (требуется Java 11+). Извлекаются строки с полями Description, Qty, Unit price, Tax, Amount; при сохранении каждой позиции автоматически определяется **тип начисления** (подписка, Fast Premium, перерасчёты, комиссия/использование токенов и т.д.) и **модель** (для токенов). Логирование каждого разбора в отдельный файл в `data/invoice-logs/`. Поддержка тарифов Cursor Teams ($40/место, $20 включено, Token Fee $0.25/1M).
- **Отчёт по счетам** — сводные таблицы по периодам биллинга (6–5) и по типам начислений; матрица период × тип.
- **Сверка Usage Events и счетов** — сопоставление сумм по Usage Events (только on-demand, kind = Usage-based) с начислениями по счетам (token_usage, token_fee) по периодам биллинга; учёт привязки счёта от 6-го числа к периоду текущего месяца.
- **Выгрузки в JSON** — выгрузка всех записей по эндпоинту (покрытие БД) и всех позиций по счетам для анализа.
- **Очистка БД от счетов** — кнопка удаления всех счетов и позиций из БД.
- **Доступ к настройкам по логину и паролю** — разделы «Настройки и загрузка», «Данные в БД», «Пользователи Jira», «Счета», «Аудит», «Отчёт по счетам», «Сверка» вынесены на отдельную страницу настроек; доступ по логину и паролю. Учётные данные хранятся в файле `data/auth.json`.

---

## 2. Стек и требования

| Компонент | Технология |
|-----------|------------|
| Сервер | Node.js 18+ (рекомендуется 20), Express |
| БД | SQLite (better-sqlite3) |
| Фронт | HTML, CSS, JavaScript (без фреймворков) |
| Парсинг PDF-счетов | [OpenDataLoader PDF](https://github.com/opendataloader-project/opendataloader-pdf) (`@opendataloader/pdf`), **требуется Java 11+** в PATH при включённом `USE_OPENDATALOADER` |
| Контейнеризация | Docker, Docker Compose |

**Внешние зависимости:** Cursor Admin API (нужен API key команды из [cursor.com/settings](https://cursor.com/settings)). Ключ хранится в общей БД (таблица `settings`). При запуске выгрузки проверяется наличие ключа; при недействительном ключе (401 от Cursor API) предлагается ввести и сохранить новый.

**Парсинг счетов:** при включённом `USE_OPENDATALOADER` (по умолчанию и локально, и в Docker) для загрузки PDF-счетов нужна **Java 11+** в PATH. В Docker-образ входит Java 17 (JRE), парсинг включён по умолчанию; отключить в контейнере можно переменной `USE_OPENDATALOADER=0`. Резервных парсеров нет.

---

## 3. Структура проекта

```
cursor-api-dashboard/
├── server.js           # Сервер: API, прокси, синхронизация, парсинг PDF-счетов (OpenDataLoader)
├── db.js               # Работа с SQLite (analytics, jira_users, cursor_invoices)
├── package.json
├── Dockerfile
├── docker-compose.yml
├── .dockerignore
├── .gitignore
├── DOCUMENTATION.md    # Этот файл
├── README.md           # Краткая инструкция по запуску
├── public/             # Статика
│   ├── index.html      # Главная: дашборд по пользователям (без входа)
│   ├── login.html      # Вход в настройки (логин/пароль)
│   ├── settings.html   # Настройки и загрузки (после входа): API key, загрузка в БД, Jira CSV, PDF-счета
│   ├── admin.html      # Редирект на settings.html
│   ├── app.js          # Логика настроек и загрузки в БД (sync-stream, покрытие, очистка)
│   ├── settings-uploads.js # Загрузка Jira CSV и PDF-счетов на странице настроек
│   ├── data.html       # Просмотр данных: вкладки «Данные в БД», «Jira», «Счета», «Аудит»
│   ├── data.js
│   ├── jira-users.js   # Вкладка Jira на data.html
│   ├── invoices.js     # Вкладка Счета на data.html
│   ├── audit.js        # Вкладка Аудит на data.html
│   ├── common.js             # Общие утилиты: escapeHtml, копирование таблиц (TSV), ENDPOINT_LABELS/getEndpointLabel
│   ├── users-dashboard.js    # Логика дашборда (index.html)
│   ├── team-snapshot.html
│   ├── team-snapshot.js
│   ├── report.html           # Сводный отчёт по счетам (по периодам биллинга и по типам начислений)
│   ├── report.js
│   ├── reconciliation.html   # Отчёт-сверка: Usage Events и счета по периодам
│   ├── reconciliation.js
│   └── styles.css
├── scripts/
│   └── deploy.sh       # Скрипт деплоя (git pull + docker compose)
└── data/               # Локально: создаётся при первом запуске. В Docker — каталог хоста /var/cursor/data
    ├── analytics.db    # SQLite (analytics, jira_users, settings, cursor_invoices, cursor_invoice_items)
    ├── auth.json       # Логин и пароль для входа в настройки (создаётся при первом запуске: admin/admin)
    ├── session_secret  # Секрет для подписи сессии (создаётся автоматически)
    ├── sync.log        # Лог синхронизации API (при SYNC_LOG_FILE)
    └── invoice-logs/   # Логи парсинга счетов: один файл на счёт (имя_файла.pdf.log); при удалении счёта лог удаляется
```

---

## 4. Запуск

### 4.1 Локально (без Docker)

```bash
npm install
npm start
```

Приложение доступно по адресу **http://localhost:3333** (порт задаётся переменной `PORT`, по умолчанию 3333).

**Доступ к настройкам:** с главной страницы ссылка «Настройки» ведёт на страницу входа. Логин и пароль задаются в файле `data/auth.json` (формат: `{"login": "admin", "password": "admin"}`). При первом запуске файл создаётся с учётными данными по умолчанию (admin/admin) — рекомендуется сменить пароль, отредактировав `data/auth.json`.

### 4.2 Docker

```bash
docker compose up --build
```

Данные (БД, настройки) хранятся в каталоге хоста **/var/cursor/data**, монтируемом в контейнер в `/data` (см. `docker-compose.yml`). Перед первым запуском на сервере можно создать каталог: `sudo mkdir -p /var/cursor/data`; скрипт `scripts/deploy.sh` создаёт его при необходимости.

### 4.3 Деплой на сервер (Ubuntu)

```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

Скрипт выполняет: `git pull`, `docker compose build --no-cache`, `docker compose up -d`. Каталог проекта по умолчанию — родитель `scripts/`; при необходимости задаётся переменной `PROJECT_DIR`.

---

## 5. Страницы и разделы

### 5.1 Главная — дашборд (`index.html`), без входа

Открывается по умолчанию. Доступ **без авторизации**.
- **Период:** начало и конец (даты). По умолчанию — период по данным Daily Usage в БД. Активность агрегируется **по месяцам**.
- **Вид:** карточки пользователей / тепловая карта / таблица по месяцам.
- **Сортировка:** по запросам, дням с активностью, строкам, событиям Usage Events, стоимости, имени.
- **Фильтр:** «Показывать только тех, у кого есть активность за период».
- **Данные:** Daily Usage Data + Usage Events (события, стоимость, токены: input/output/cache, разбивка по моделям) + при наличии Jira (имена, статус Активный/Архивный, проект, даты подключения/отключения). Статус и даты в Jira определяются по записи с самой свежей «Датой начала подписки».
- **Сводка:** запросы, строки ±, события и стоимость Usage Events, токены (М/К), расходы текущего месяца (Spend API), участники команды, стоимость по моделям (таблица).
- **Активные в Jira, но не используют / редко используют Cursor:** таблица с сортировкой по столбцам (по умолчанию — по «Последняя активность», сначала кто давно не использовал).
- **Затраты по проекту (помесячно):** таблица по проектам Jira с помесячной стоимостью Usage Events и итогом Spend API.
- Ссылка **«Настройки»** ведёт на страницу входа (`login.html`).

### 5.2 Вход и страница настроек (`login.html`, `settings.html`)

- **Вход:** логин и пароль из файла `data/auth.json`. При первом запуске создаётся файл с учётными данными по умолчанию (admin/admin). Сессия хранится в cookie (24 ч).
- **После входа** открывается `settings.html` — одна страница «Настройки и загрузки»: API key, загрузка в БД, загрузка Jira CSV, загрузка PDF-счетов. Ссылки внизу ведут на Дашборд, Участники и расходы, Данные.

### 5.3 Настройки и загрузки (`settings.html`), только после входа

- **Настройки:** ввод API key, сохранение в БД (кнопка «Сохранить ключ в БД»). Если ключ уже сохранён, отображается «Ключ сохранён в БД» и ссылка «Изменить ключ».
- **Загрузка в БД:** поле «Начальная дата» (по умолчанию 01.09.2025), кнопка «Загрузить и сохранить в БД» — потоковая синхронизация (`/api/sync-stream`), прогресс и лог. Покрытие БД по эндпоинтам, кнопки «Очистить только данные API», «Полная очистка БД».
- **Загрузка CSV (Jira):** выбор файла, кнопка «Загрузить CSV» — полная замена записей в `jira_users`.
- **Загрузка PDF (счета Cursor):** выбор одного или нескольких PDF, кнопка «Загрузить выбранные PDF». Парсинг через OpenDataLoader; дубликаты по хешу файла не принимаются (409).

Запрос к `admin.html` — редирект на `settings.html`.

### 5.4 Просмотр данных (`data.html`), только после входа

Одна страница с вкладками:

- **Данные в БД:** покрытие БД (таблица по эндпоинтам с датами и числом дней), кнопка «Скачать JSON» по каждому эндпоинту (выгрузка всех записей за период в JSON для анализа). Фильтры по эндпоинту и датам, кнопка «Показать данные» — единая таблица записей. Для Usage Events поля `tokenUsage` развёрнуты в отдельные колонки.
- **Jira:** текущий список пользователей из БД (таблица), кнопки «Обновить» и «Очистить данные Jira».
- **Счета:** справочно — тариф Teams ($40/место, $20 включено, Cursor Token Fee $0.25/1M токенов). Список загруженных счетов; кнопка «Очистить БД от счетов» (удаление всех счетов и позиций); просмотр позиций счёта с колонками **Тип** (тип начисления) и **Модель** (для токенов); единая таблица «Все позиции по счетам» с теми же колонками и кнопка «Скачать JSON». Удаление отдельного счёта — по кнопке у каждого счёта.
- **Аудит:** события Audit Logs из БД. Фильтры: период, тип события, лимит. Кнопка «Показать» — таблица событий.

Переключение вкладок — по ссылкам или по хешу в URL (`#data`, `#jira`, `#invoices`, `#audit`).

### 5.5 Отчёт по счетам (`report.html`), только после входа

Сводный отчёт по данным из загруженных счетов. Доступ по ссылке «Отчёт по счетам» в навигации.

- **По периодам биллинга** — таблица: период (подпись «6 [месяц] – 5 [след. месяц]», цикл с 6-го по 5-е включительно), число позиций, сумма в $. Период определяется по дате счёта: ключ периода = месяц окончания цикла (5-го числа).
- **По типам начислений** — таблица: тип (Ежемесячная подписка, Fast Premium, начисление/возврат мест, комиссия за токены, использование токенов, прочее), число позиций, сумма в $, % от общей.
- **Матрица период × тип** — суммы в $ по каждому периоду и типу, итоги по строкам и столбцам.

Данные запрашиваются из `/api/invoices/all-items` и агрегируются на клиенте.

### 5.6 Отчёт-сверка (`reconciliation.html`), только после входа

Сопоставление данных **Usage Events** (из БД) с начислениями по **счетам** (позиции token_usage и token_fee) по периодам биллинга. Доступ по ссылке «Сверка» в навигации.

- **Сводная таблица по периодам:** для каждого периода — число событий Usage (только **kind = Usage-based**, on-demand), сумма по Usage ($), число позиций счёта, сумма по счёту ($), разница ($). Строка **Итого** — общая сумма Usage, общая сумма счёта и общая разница.
- **Правила:** события «Included in Business» (в рамках $20/место) в сумму Usage не попадают — на счёт они отдельно не выставляются. Периоды подписаны «6 [месяц] – 5 [след. месяц]». Счета с датой **6-го числа** относятся к периоду, закончившемуся 5-го этого месяца (тот же месяц в ключе). Положительная разница в одном периоде может быть из‑за «догоняющего» биллинга (часть usage из прошлых периодов попала на счёт следующего).

Данные запрашиваются из `GET /api/reconciliation`.

### 5.7 Редиректы

- Запрос к `/users-dashboard.html` — редирект 302 на `/index.html`.
- Запрос к `admin.html` — редирект на `settings.html`.

---

### 5.8 Что загружается в БД и что отображается на дашборде

| Эндпоинт (загрузка) | Где отображается | Примечание |
|--------------------|------------------|------------|
| **Daily Usage Data** | Дашборд (index) | Запросы, дни активности, строки ±, applies/accepts по пользователям и месяцам. |
| **Usage Events** (filtered-usage-events) | Дашборд (index) | События, стоимость в $, разбивка по моделям. |
| **Пользователи Jira** (CSV) | Дашборд (index), страница Jira | Имена, статус активный/архивный, проект, даты подключения/отключения. |
| **Team Members** | Дашборд (сводка), Данные в БД | Число участников и список в сводке; сырые данные в data.html. |
| **Audit Logs** | Страница «Данные» → вкладка «Аудит» | Фильтр по дате и типу на data.html#audit. |
| **Spending Data** | Дашборд (сводка и по пользователям) | Расходы текущего месяца из `/teams/spend` в сводке и в карточках/таблице пользователей. |

Всё загруженное можно просмотреть на странице **«Данные»** (вкладки «Данные в БД», «Jira», «Счета», «Аудит»). На **главном дашборде** используются Daily Usage, Usage Events, Jira, Team Members и Spending Data.

---

## 6. API сервера (бэкенд)

Базовый URL: `http://localhost:3333` (или ваш хост).

**Авторизация настроек:** эндпоинты, помеченные «(только после входа)», требуют валидной сессии (cookie после успешного `POST /api/login`). Без сессии возвращается 401 или редирект на `/login.html`.

### 6.1 Вход и проверка сессии

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/login` | Тело: `{ login, password }`. Сверка с `data/auth.json`. При успехе — cookie сессии, ответ `{ ok: true }`. |
| POST | `/api/logout` | Сброс cookie сессии. |
| GET | `/api/auth/check` | Ответ: `{ authenticated: boolean }`. |

### 6.2 Конфигурация и прокси (только после входа)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/config` | Ответ: `{ apiKeyConfigured: boolean }`. |
| POST | `/api/config` | Тело: `{ apiKey }`. Сохраняет ключ в БД (таблица `settings`). |
| GET | `/api/proxy?path=...&startDate=...&endDate=...` | Прокси GET к Cursor API. `path` — например `/teams/members`, `/teams/audit-logs?...`. Требуется API key (заголовок `X-API-Key` или из файла/переменной). |
| POST | `/api/proxy` | Тело: `{ path, ...params }`. Прокси POST к Cursor API. |

Допустимые префиксы `path`: `/teams/`, `/settings/`. На сервере действует rate limit (по умолчанию 120 запросов с одного IP в минуту) и соблюдаются лимиты Cursor API (20/60 запр/мин в зависимости от эндпоинта).

### 6.3 Синхронизация в БД (только после входа)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/sync` | Тело: `{ startDate, endDate }` (YYYY-MM-DD). Синхронизация в БД без потока. |
| POST | `/api/sync-stream` | То же тело. Ответ — поток SSE. События: `progress`, `done`, `error`. |

Эндпоинты синхронизации:

- **Snapshot (один запрос за запуск):** `/teams/members`, `/teams/spend`.
- **По периодам (чанки по 30 дней):** `/teams/audit-logs`, `/teams/daily-usage-data`, `/teams/filtered-usage-events`. Для каждого эндпоинта вычисляются даты, которых ещё нет в БД; по ним строятся непрерывные «дыры» и разбиваются на чанки по 30 дней. Таким образом за период больше 30 дней запрашиваются только недостающие диапазоны, без повторной загрузки уже имеющихся данных.

### 6.4 Счета Cursor (только после входа)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/invoices/upload` | Тело: `multipart/form-data`, поле `pdf` — файл PDF. Парсинг через OpenDataLoader; при успехе — сохранение в БД, ответ `{ ok, invoice_id, filename, items_count }`. При дубликате по хешу файла — 409 и `existing_invoice`. При ошибке парсинга (OPENDATALOADER_DISABLED, OPENDATALOADER_ERROR, OPENDATALOADER_EMPTY) — 400 с сообщением. |
| GET | `/api/invoices` | Список счетов: `{ invoices: [ { id, filename, parsed_at, items_count }, ... ] }`. |
| GET | `/api/invoices/:id/items` | Позиции счёта: `{ items, issue_date }`. Каждый item: row_index, description, quantity, unit_price_cents, tax_pct, amount_cents, raw_columns, **charge_type**, **model**. 404 если счёт не найден. |
| GET | `/api/invoices/all-items` | Все позиции по всем счетам (для отчётов): `{ items: [ { invoice_id, invoice_filename, invoice_issue_date, ..., charge_type, model }, ... ] }`. |
| DELETE | `/api/invoices` | Удаление **всех** счетов и позиций из БД. Ответ `{ ok: true, message }`. |
| DELETE | `/api/invoices/:id` | Удаление счёта и всех его позиций; удаляется также лог в `INVOICE_LOGS_DIR` (имя файла счёта + `.log`). Ответ `{ ok: true }` или 404. |
| GET | `/api/reconciliation` | Сводка для сверки Usage Events и счетов: `{ usageByPeriod, invoiceByPeriod, comparison: [ { periodKey, periodLabel, usageEventCount, usageCostCents, invoiceItemCount, invoiceCostCents, diffCents }, ... ], totals: { totalUsageCents, totalInvoiceCents, totalDiffCents } }`. Учитываются только события с kind = Usage-based; периоды биллинга 6–5. |

### 6.5 Аналитика и пользователи

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/analytics?endpoint=...&startDate=...&endDate=...` | Выборка из таблицы `analytics`. Ответ: `{ data: [ { endpoint, date, payload, updated_at }, ... ] }`. (только после входа) |
| GET | `/api/analytics/coverage` | Ответ: `{ coverage: [ { endpoint, min_date, max_date, days }, ... ] }`. (только после входа) |
| GET | `/api/users/default-period` | **Без авторизации.** Период по умолчанию для дашборда: min/max даты Daily Usage в БД. Ответ: `{ startDate, endDate }` или `{ startDate: null, endDate: null }`. |
| GET | `/api/users/activity-by-month?startDate=...&endDate=...` | Агрегация Daily Usage и Usage Events по пользователям и месяцам. Ответ: `{ users, months }`. У пользователя: `displayName`, `email`, `jiraStatus`, `jiraProject`, `jiraConnectedAt`, `jiraDisconnectedAt`, `monthlyActivity: [ ... ]`. Пользователи — из Jira (CSV) и/или из Cursor по email. |
| POST | `/api/clear-db` | Тело: `{ clearSettings?: boolean }`. Полная очистка БД. (только после входа) |
| GET | `/api/jira-users` | Ответ: `{ users: [ ... ] }` — массив объектов из таблицы `jira_users`. |
| POST | `/api/jira-users/upload` | Тело: `{ csv: "строка CSV" }`. Полная замена записей в `jira_users`. (только после входа) |

---

## 7. База данных (SQLite)

Каталог БД задаётся переменной `DATA_DIR` (по умолчанию `./data`; в Docker в контейнере — `/data`, на хосте — `/var/cursor/data`, монтируется в `docker-compose.yml`).

### 7.1 Таблица `analytics`

| Колонка | Тип | Описание |
|---------|-----|----------|
| endpoint | TEXT | Путь эндпоинта, например `/teams/daily-usage-data`. |
| date | TEXT | Дата в формате YYYY-MM-DD. |
| payload | TEXT | JSON ответа API (или его часть, разложенная по дням). |
| updated_at | TEXT | Время последнего обновления. |

**Первичный ключ:** `(endpoint, date)`. При повторной загрузке дня запись обновляется (upsert).

### 7.2 Таблица `jira_users`

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | INTEGER | AUTOINCREMENT. |
| data | TEXT | JSON одного «строки» из CSV (объект с полями вроде «Внешний почтовый адрес», «Email» и т.д.). |
| updated_at | TEXT | Время последнего обновления. |

При загрузке CSV таблица очищается и заполняется заново.

### 7.3 Таблицы счетов Cursor

**`cursor_invoices`**

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT. |
| filename | TEXT | Имя загруженного файла. |
| file_path | TEXT | Не используется (оставлено для совместимости). |
| file_hash | TEXT | SHA-256 хеш файла; уникальный индекс для проверки дубликатов. |
| issue_date | TEXT | Дата счёта YYYY-MM-DD (извлекается из PDF при парсинге). |
| parsed_at | TEXT | Время загрузки/парсинга. |

**`cursor_invoice_items`**

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT. |
| invoice_id | INTEGER | FK на cursor_invoices(id), ON DELETE CASCADE. |
| row_index | INTEGER | Порядковый номер строки в таблице счёта. |
| description | TEXT | Описание позиции. |
| quantity | REAL | Количество. |
| unit_price_cents | INTEGER | Цена за единицу в центах. |
| tax_pct | REAL | Налог, %. |
| amount_cents | INTEGER | Сумма в центах. |
| raw_columns | TEXT | JSON массива сырых значений колонок. |
| charge_type | TEXT | Тип начисления: monthly_subscription, fast_premium_per_seat, fast_premium_usage, proration_charge, proration_refund, token_fee, token_usage, other. Заполняется при загрузке PDF. |
| model | TEXT | Модель (для token_fee и token_usage), например gpt-5.2-codex. Заполняется при загрузке PDF. |

Уникальность: `(invoice_id, row_index)`.

**Классификация позиций счёта (charge_type, model).** При сохранении позиций после парсинга PDF сервер вызывает классификатор по полю `description` и дате счёта (`issue_date`). Типы: `monthly_subscription` (ежемесячная подписка, дата 6-го), `fast_premium_per_seat`, `fast_premium_usage` (сверх лимита 500/месяц), `proration_charge` / `proration_refund`, `token_fee` / `token_usage` (модель извлекается из описания, например gpt-5.2-codex), `other`. Учитываются форматы дат вида «Dec 5, 2025 – Jan 5, 2026» и строки «Remaining/Unused time on Cursor Business» без префикса «N ×». Функция очистки только счетов: `clearCursorInvoices()` в db.js (удаляет `cursor_invoice_items` и `cursor_invoices`).

**Периоды биллинга.** Цикл с 6-го по 5-е включительно. Ключ периода для событий Usage: месяц даты окончания цикла (5-го). Для счетов: счёт с датой **6-го числа** относится к периоду текущего месяца (цикл только что закончился 5-го); счета с другой датой — к периоду по общему правилу. Подпись периода в интерфейсе: «6 [месяц] – 5 [след. месяц]».

### 7.4 Вспомогательные функции (db.js)

- `getExistingDates(endpoint, startDate, endDate)` — массив дат (YYYY-MM-DD), по которым уже есть данные для эндпоинта в указанном диапазоне. Используется при синхронизации для построения недостающих диапазонов: запрашиваются только чанки по «дырам» (без повторной загрузки одних и тех же дней).
- Для счетов: `getCursorInvoices`, `getCursorInvoiceById`, `getCursorInvoiceItems`, `getCursorInvoiceByFileHash`, `insertCursorInvoice`, `insertCursorInvoiceItem(..., chargeType, model)`, `deleteCursorInvoice`, `clearCursorInvoices` (только счета и позиции). При полной очистке БД (`clearAllData`) удаляются также `cursor_invoices` и `cursor_invoice_items`.

---

## 8. Логика синхронизации (загрузка в БД)

1. **Граница периода:** конечная дата на сервере ограничивается **вчера** (текущий день не загружается).
2. **Начальная дата:** задаётся пользователем; по умолчанию на фронте — **01.09.2025**.
3. **Чанки по 30 дней:** период от начальной даты до вчера разбивается на отрезки по 30 дней (лимит Cursor API).
4. **Пропуск уже загруженных данных:** для каждого daterange-эндпоинта запрашивается множество дат из БД в этом периоде. Чанк пропускается, если для **всех** дней этого чанка уже есть записи. Иначе чанк запрашивается у Cursor API и сохраняется (upsert по дням).
5. **Snapshot-эндпоинты** (members, spend) запрашиваются один раз за запуск синхронизации.
6. **Прогресс:** при использовании `/api/sync-stream` число шагов равно: количество snapshot-эндпоинтов + сумма по daterange-эндпоинтам числа чанков, которые реально запрашиваются (без полностью заполненных).

---

## 9. Переменные окружения

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `PORT` | Порт HTTP-сервера. | 3333 |
| `DATA_DIR` | Каталог для БД, auth.json, session_secret, sync.log, invoice-logs. | `./data` (от корня приложения) |
| `CURSOR_API_KEY` | API key команды Cursor (если не хранить в БД и не вводить на сайте). | — |
| `CORS_ORIGIN` | Разрешённые origins через запятую. | все |
| `PROXY_TIMEOUT_MS` | Таймаут запроса к Cursor API, мс. | 60000 |
| `RATE_LIMIT_MAX` | Максимум запросов с одного IP в минуту к нашему серверу. | 120 |
| `SYNC_LOG_FILE` | Путь к файлу лога синхронизации (append). | `data/sync.log` |
| `SESSION_SECRET` | Секрет для подписи сессии (если не использовать файл `data/session_secret`). | генерируется в файл |
| `USE_OPENDATALOADER` | Включить парсинг PDF-счетов через OpenDataLoader. Требуется **Java 11+** в PATH (в Docker-образе установлена Java 17). Отключить: `0` или `false`. | включено (если не `0`/`false`) |
| `OPENDATALOADER_TABLE_METHOD` | Метод детекции таблиц OpenDataLoader: `default` (по границам) или `cluster`. | не задаётся |
| `OPENDATALOADER_USE_STRUCT_TREE` | Если `1` или `true` — использовать структуру тегов PDF (tagged PDF) для порядка чтения. | не задаётся |
| `INVOICE_LOGS_DIR` | Каталог логов парсинга счетов. Для каждого счёта — файл `имя_файла.pdf.log`; при удалении счёта лог удаляется. | `DATA_DIR/invoice-logs` |
| `TRUST_PROXY` | Если `1` или `true` — доверять заголовку `X-Forwarded-For` (за прокси). Нужно при работе за nginx/apache для корректного IP при лимитах входа и rate limit. | не задаётся |

---

## 9.1 Логирование процесса загрузки (sync)

При синхронизации (кнопка «Загрузить и сохранить в БД») в stdout и при необходимости в файл (`SYNC_LOG_FILE`) пишутся строки формата:

```
[SYNC] ISO_TIMESTAMP action=... key=value ...
```

**Действия (action):**

| action | Описание |
|--------|----------|
| `start` | Старт синхронизации: startDate, endDate, endCapped, totalSteps. |
| `request` | Перед запросом к Cursor API: endpoint, method, chunkLabel, page (если есть). |
| `response` | Успешный ответ: endpoint, status, durationMs. |
| `saved` | После записи в БД: endpoint, records, days. |
| `retry` | Повтор из-за 429: endpoint, status, attempt, durationMs. |
| `error` | Ошибка запроса или эндпоинта: endpoint, status, error, durationMs. |
| `skipped` | Эндпоинт пропущен (функция не включена): endpoint, reason. |
| `complete` | Конец синхронизации: saved, okCount, errorsCount, skippedCount, errors (текст). |

**Анализ лога:** ошибки искать по `action=error` или `action=complete` с `errorsCount>0`. По `durationMs` можно находить медленные запросы. Пример (bash): `grep '\[SYNC\]' sync.log | grep 'action=error'`.

---

## 9.2 Парсинг PDF-счетов (OpenDataLoader) и логирование

**Парсер:** используется только [OpenDataLoader PDF](https://github.com/opendataloader-project/opendataloader-pdf) (пакет `@opendataloader/pdf`). Вызов по [Quick Start Node.js](https://opendataloader.org/docs/quick-start-nodejs), вывод в JSON по [JSON Schema](https://opendataloader.org/docs/json-schema). Резервных парсеров нет: при `USE_OPENDATALOADER=0`, ошибке выполнения (например отсутствие Java) или пустом результате загрузка счёта возвращает ошибку клиенту.

**Извлечение таблицы:** в JSON ищется таблица с заголовками Description, Qty, Unit price (опционально), Tax (опционально), Amount. Функция `extractInvoiceRowsFromOdlTable()` определяет индексы колонок по заголовкам и для каждой строки данных извлекает: description, quantity, unit_price_cents, tax_pct, amount_cents. Поддерживаются форматы с колонкой Tax и без неё. Числа и валютные суммы парсятся с учётом символа `$` и запятых; применяется нормализация текста (в т.ч. склейка сумм, разорванных переносами строк, и нестандартных пробелов).

**Логирование:** для каждого загружаемого счёта создаётся/перезаписывается файл в `INVOICE_LOGS_DIR` с именем `имя_файла.pdf.log` (недопустимые символы в имени заменяются на `_`). В лог пишутся:
- заголовок: время, имя файла, парсер, число извлечённых строк, длительность (мс), код ошибки при наличии;
- **этапы парсинга (logSteps):** для поиска проблем с парсером по шагам:
  - `start` — размер буфера PDF;
  - `java` — JAVA_HOME (авто или из окружения);
  - `temp` — путь к временному PDF и каталогу вывода;
  - `convert_options` — параметры вызова OpenDataLoader (tableMethod, useStructTree и т.д.);
  - `convert_done` — длительность convert() в мс;
  - `output_dir` — список файлов в каталоге после конвертации;
  - `json_read` — какой .json прочитан и его размер;
  - `doc_structure` — число элементов doc.kids и типы верхнего уровня;
  - `find_table` — найдена ли таблица с заголовками Description/Qty/Amount, число строк, текст заголовков;
  - `extract_rows` — число извлечённых строк, индексы колонок, пример первой строки;
  - `success` / `empty_extract` / `no_doc_kids` / `error` — итог или причина пустого результата;
- фрагмент JSON OpenDataLoader (до 50K символов) при наличии. При удалении счёта через API соответствующий лог-файл удаляется.

---

## 10. Лимиты Cursor Admin API

- Большинство эндпоинтов: **20 запросов в минуту** на команду.
- `/teams/user-spend-limit`: **60 запросов в минуту**.

Сервер при прокси и синхронизации троттлит запросы по эндпоинтам, чтобы не превышать эти лимиты.

---

## 11. Безопасность

- **Защищённые страницы (только после входа):** доступ по прямой ссылке без авторизации закрыт. Список: `admin.html`, `data.html`, `settings.html`. Проверка пути выполняется без учёта регистра; перед отдачей статики запрос перехватывается и требуется валидная сессия, иначе редирект на `/login.html`.
- **Учётные данные:** логин и пароль хранятся в `data/auth.json` (каталог `data/` в `.gitignore`). Рекомендуется сменить пароль по умолчанию (admin/admin).
- **Ограничение попыток входа:** с одного IP допускается не более 5 неудачных попыток входа за 15 минут; при превышении возвращается 429 с сообщением «Слишком много попыток входа…».
- **Сессия:** подпись cookie через HMAC-SHA256, секрет в `data/session_secret` или в `SESSION_SECRET`. Срок жизни сессии — 24 часа.
- **API key** не логируется и не отдаётся клиенту; хранится в БД.
- **Обратный прокси:** при работе за nginx/apache задайте переменную окружения `TRUST_PROXY=1`, чтобы корректно определялся IP клиента для лимитов входа и общего rate limit.
- Для продакшена: задать `CORS_ORIGIN`, при необходимости ограничить доступ по сети (фаервол, обратный прокси).

---

## 12. Ссылки

- [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api)
- [API Overview (аутентификация, лимиты)](https://cursor.com/docs/api)
- [OpenDataLoader PDF](https://github.com/opendataloader-project/opendataloader-pdf) — парсинг PDF-счетов
- [OpenDataLoader Quick Start (Node.js)](https://opendataloader.org/docs/quick-start-nodejs)
- [OpenDataLoader JSON Schema](https://opendataloader.org/docs/json-schema)

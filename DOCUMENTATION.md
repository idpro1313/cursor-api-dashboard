# Документация: Cursor API Dashboard

Веб-приложение для работы с [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api): прокси запросов, сохранение аналитики в локальную БД и дашборды по использованию Cursor командой.

---

## 1. Назначение и возможности

- **Прокси к Cursor Admin API** — запросы к API выполняются с сервера, API key не передаётся в браузер.
- **Синхронизация в БД** — загрузка данных по эндпоинтам (members, audit-logs, daily-usage-data, spend, filtered-usage-events) с указанной даты по вчера с сохранением в SQLite. Уже загруженные дни не запрашиваются повторно; текущий день не загружается.
- **Просмотр данных в БД** — фильтрация по эндпоинту и диапазону дат, просмотр покрытия.
- **Пользователи Jira** — загрузка CSV (экспорт из Jira) для сопоставления с активностью Cursor по email.
- **Дашборд по пользователям** — статистика использования Cursor по месяцам: запросы, дни активности, строки кода, применения/принятия; виды: карточки, тепловая карта, таблица.

---

## 2. Стек и требования

| Компонент | Технология |
|-----------|------------|
| Сервер | Node.js 18+ (рекомендуется 20), Express |
| БД | SQLite (better-sqlite3) |
| Фронт | HTML, CSS, JavaScript (без фреймворков) |
| Контейнеризация | Docker, Docker Compose |

**Внешние зависимости:** Cursor Admin API (нужен API key команды из [cursor.com/settings](https://cursor.com/settings)).

---

## 3. Структура проекта

```
cursor-api-dashboard/
├── server.js           # Сервер: API, прокси, синхронизация
├── db.js               # Работа с SQLite (analytics, jira_users)
├── package.json
├── Dockerfile
├── docker-compose.yml
├── .dockerignore
├── .gitignore
├── DOCUMENTATION.md    # Этот файл
├── README.md           # Краткая инструкция по запуску
├── public/             # Статика
│   ├── index.html      # Главная: настройки, загрузка в БД, эндпоинты
│   ├── app.js          # Логика главной (sync-stream, покрытие)
│   ├── data.html       # Просмотр данных в БД
│   ├── data.js
│   ├── jira-users.html # Загрузка CSV Jira
│   ├── jira-users.js
│   ├── users-dashboard.html  # Статистика по пользователям/месяцам
│   ├── users-dashboard.js
│   └── styles.css
├── scripts/
│   └── deploy.sh       # Скрипт деплоя (git pull + docker compose)
└── data/               # Создаётся при первом запуске (или том в Docker)
    ├── analytics.db    # SQLite
    └── api-key.txt     # API key (опционально, можно ввести на сайте)
```

---

## 4. Запуск

### 4.1 Локально (без Docker)

```bash
npm install
npm start
```

Приложение доступно по адресу **http://localhost:3333** (порт задаётся переменной `PORT`, по умолчанию 3333).

### 4.2 Docker

```bash
docker compose up --build
```

Данные (БД и `api-key.txt`) хранятся в томе `cursor-data`, монтируемом в `/data` (см. `docker-compose.yml`).

### 4.3 Деплой на сервер (Ubuntu)

```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

Скрипт выполняет: `git pull`, `docker compose build --no-cache`, `docker compose up -d`. Каталог проекта по умолчанию — родитель `scripts/`; при необходимости задаётся переменной `PROJECT_DIR`.

---

## 5. Страницы и разделы

### 5.1 Главная (`index.html`)

- **Настройки:** ввод API key, сохранение в файл `data/api-key.txt` (кнопка «Сохранить ключ в файл»). Если ключ уже в файле или в `CURSOR_API_KEY`, поле скрыто.
- **Сохранение в локальную БД:**
  - Поле «Начальная дата» — по умолчанию **01.09.2025**. Загрузка выполняется с этой даты по **вчера** (текущий день не загружается).
  - Кнопка «Загрузить и сохранить в БД» запускает потоковую синхронизацию (`/api/sync-stream`): отображаются прогресс-бар и текст шага (эндпоинт, период, число записей). Запрашиваются только те 30-дневные чанки, по которым в БД ещё не все дни.
  - Блок «Покрытие БД» — таблица по эндпоинтам: минимальная/максимальная дата и количество дней.
- **Эндпоинты Admin API:** чекбоксы для ручного вызова прокси (GET/POST) по выбранным эндпоинтам; результаты выводятся на странице (для сценариев разовой выгрузки без сохранения в БД).

### 5.2 Данные в БД (`data.html`)

- Покрытие БД (какие эндпоинты и за какие даты есть данные).
- Фильтры: эндпоинт, «с даты», «по дату». Кнопка «Показать данные» — запрос к `GET /api/analytics` и отображение карточек по датам и эндпоинтам (таблицы или JSON по структуре ответа API).

### 5.3 Пользователи Jira (`jira-users.html`)

- Загрузка CSV (экспорт из Jira): выбор файла и кнопка «Загрузить CSV». При загрузке текущие записи в таблице `jira_users` **полностью заменяются**.
- Отображение текущего списка пользователей из БД. Сопоставление с Cursor по полям «Внешний почтовый адрес», «Email» и т.п.

### 5.4 Дашборд по пользователям (`users-dashboard.html`)

- **Период:** начало и конец (даты). Активность агрегируется **по месяцам**.
- **Вид:** карточки пользователей / тепловая карта / таблица по месяцам.
- **Сортировка:** по запросам, по дням с активностью, по изменённым строкам, по имени.
- **Фильтр:** «Показывать только тех, у кого есть активность за период».
- Данные: эндпоинт **Daily Usage Data** из БД + при наличии — пользователи Jira (для отображения имён). Если Jira не загружен, показываются пользователи только по email из Cursor.
- В карточках дополнительно выводятся применения и принятия подсказок (из Daily Usage API).

---

## 6. API сервера (бэкенд)

Базовый URL: `http://localhost:3333` (или ваш хост).

### 6.1 Конфигурация и прокси

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/config` | Ответ: `{ apiKeyConfigured: boolean }`. |
| POST | `/api/config` | Тело: `{ apiKey }`. Сохраняет ключ в `data/api-key.txt`. |
| GET | `/api/proxy?path=...&startDate=...&endDate=...` | Прокси GET к Cursor API. `path` — например `/teams/members`, `/teams/audit-logs?...`. Требуется API key (заголовок `X-API-Key` или из файла/переменной). |
| POST | `/api/proxy` | Тело: `{ path, ...params }`. Прокси POST к Cursor API. |

Допустимые префиксы `path`: `/teams/`, `/settings/`. На сервере действует rate limit (по умолчанию 120 запросов с одного IP в минуту) и соблюдаются лимиты Cursor API (20/60 запр/мин в зависимости от эндпоинта).

### 6.2 Синхронизация в БД

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/sync` | Тело: `{ startDate, endDate }` (YYYY-MM-DD). Синхронизация в БД без потока; ответ — JSON с полем `saved`, `ok`, `errors`, `skipped`. Конечная дата на сервере ограничивается вчерашним днём; загружаются только чанки, по которым в БД не все дни. |
| POST | `/api/sync-stream` | То же тело. Ответ — поток SSE (Server-Sent Events). События: `progress` (currentStep, totalSteps, endpointLabel, chunkLabel, savedInStep, totalSaved), `done` (итоговый результат как у `/api/sync`), `error`. |

Эндпоинты синхронизации:

- **Snapshot (один запрос за запуск):** `/teams/members`, `/teams/spend`.
- **По периодам (чанки по 30 дней):** `/teams/audit-logs`, `/teams/daily-usage-data`, `/teams/filtered-usage-events`. Для каждого эндпоинта запрашиваются только те чанки, где есть хотя бы один день, отсутствующий в БД.

### 6.3 Аналитика и пользователи

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/analytics?endpoint=...&startDate=...&endDate=...` | Выборка из таблицы `analytics`. Ответ: `{ data: [ { endpoint, date, payload, updated_at }, ... ] }`. |
| GET | `/api/analytics/coverage` | Ответ: `{ coverage: [ { endpoint, min_date, max_date, days }, ... ] }`. |
| GET | `/api/users/activity-by-month?startDate=...&endDate=...` | Агрегация Daily Usage по пользователям и месяцам. Ответ: `{ users, months }`. У каждого пользователя: `displayName`, `email`, `monthlyActivity: [ { month, activeDays, requests, linesAdded, linesDeleted, applies, accepts }, ... ]`. Пользователи — из Jira (если загружен CSV) и/или только из Cursor по email. |
| GET | `/api/jira-users` | Ответ: `{ users: [ ... ] }` — массив объектов из таблицы `jira_users`. |
| POST | `/api/jira-users/upload` | Тело: `{ csv: "строка CSV" }`. Полная замена записей в `jira_users`. |

---

## 7. База данных (SQLite)

Каталог БД и файла ключа задаётся переменной `DATA_DIR` (по умолчанию `./data`, в Docker — `/data` с томом).

### 7.1 Таблица `analytics`

| Колонка | Тип | Описание |
|---------|-----|----------|
| endpoint | TEXT | Путь эндпоинта, например `/teams/daily-usage-data`. |
| date | TEXT | Дата в формате YYYY-MM-DD. |
| payload | TEXT | JSON ответа API (или его часть, разложенная по дням). |
| updated_at | TEXT | Время последнего обновления. |

**Первичный ключ:** `(endpoint, date)`. При повторной загрузке дня запись обновляется (upsert).

### 7.2 Таблица `jira_users`

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | INTEGER | AUTOINCREMENT. |
| data | TEXT | JSON одного «строки» из CSV (объект с полями вроде «Внешний почтовый адрес», «Email» и т.д.). |
| updated_at | TEXT | Время последнего обновления. |

При загрузке CSV таблица очищается и заполняется заново.

### 7.3 Вспомогательные функции (db.js)

- `getExistingDates(endpoint, startDate, endDate)` — массив дат (YYYY-MM-DD), по которым уже есть данные для эндпоинта в указанном диапазоне. Используется при синхронизации, чтобы не запрашивать чанки, полностью покрытые БД.

---

## 8. Логика синхронизации (загрузка в БД)

1. **Граница периода:** конечная дата на сервере ограничивается **вчера** (текущий день не загружается).
2. **Начальная дата:** задаётся пользователем; по умолчанию на фронте — **01.09.2025**.
3. **Чанки по 30 дней:** период от начальной даты до вчера разбивается на отрезки по 30 дней (лимит Cursor API).
4. **Пропуск уже загруженных данных:** для каждого daterange-эндпоинта запрашивается множество дат из БД в этом периоде. Чанк пропускается, если для **всех** дней этого чанка уже есть записи. Иначе чанк запрашивается у Cursor API и сохраняется (upsert по дням).
5. **Snapshot-эндпоинты** (members, spend) запрашиваются один раз за запуск синхронизации.
6. **Прогресс:** при использовании `/api/sync-stream` число шагов равно: количество snapshot-эндпоинтов + сумма по daterange-эндпоинтам числа чанков, которые реально запрашиваются (без полностью заполненных).

---

## 9. Переменные окружения

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `PORT` | Порт HTTP-сервера. | 3333 |
| `DATA_DIR` | Каталог для `analytics.db` и `api-key.txt`. | `./data` (от корня приложения) |
| `CURSOR_API_KEY` | API key команды Cursor (если не хранить в файле и не вводить на сайте). | — |
| `CORS_ORIGIN` | Разрешённые origins через запятую. | все |
| `PROXY_TIMEOUT_MS` | Таймаут запроса к Cursor API, мс. | 60000 |
| `RATE_LIMIT_MAX` | Максимум запросов с одного IP в минуту к нашему серверу. | 120 |

---

## 10. Лимиты Cursor Admin API

- Большинство эндпоинтов: **20 запросов в минуту** на команду.
- `/teams/user-spend-limit`: **60 запросов в минуту**.

Сервер при прокси и синхронизации троттлит запросы по эндпоинтам, чтобы не превышать эти лимиты.

---

## 11. Безопасность

- API key не логируется; при использовании ключа из файла или заголовка он не отдаётся клиенту в ответах.
- Для продакшена рекомендуется задать `CORS_ORIGIN` и при необходимости ограничить доступ по сети (фаервол, обратный прокси с аутентификацией).
- Файл `data/api-key.txt` желательно не коммитить в репозиторий (добавьте в `.gitignore` при необходимости).

---

## 12. Ссылки

- [Cursor Admin API](https://cursor.com/docs/account/teams/admin-api)
- [API Overview (аутентификация, лимиты)](https://cursor.com/docs/api)
